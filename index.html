<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ResQNet | NGO Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 600px; border-radius: 12px; }
        .incident-card { transition: transform 0.2s; }
        .incident-card:hover { transform: scale(1.02); }
    </style>
</head>
<body class="bg-[#0f172a] text-slate-200 font-sans">

    <header class="bg-[#1e293b] border-b border-slate-700 p-4 sticky top-0 z-[1000]">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-red-500 tracking-tight">ResQNet <span class="text-slate-400 font-light">NGO</span></h1>
            <div class="flex items-center space-x-4">
                <span class="bg-green-500/10 text-green-400 px-3 py-1 rounded-full text-xs font-medium border border-green-500/20">System Live</span>
                <span class="text-slate-400 text-sm">Jaipur HQ</span>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-4 gap-6">
        
        <div class="lg:col-span-1 space-y-6">
            <div class="bg-[#1e293b] p-5 rounded-xl border border-slate-700 shadow-xl">
                <h3 class="text-blue-400 text-sm font-bold uppercase mb-4 tracking-wider">Live AI Predictions</h3>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                        <p class="text-xs text-slate-400">Ambulances</p>
                        <p id="amb-count" class="text-2xl font-bold text-white">--</p>
                    </div>
                    <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                        <p class="text-xs text-slate-400">Fire Vans</p>
                        <p id="fire-count" class="text-2xl font-bold text-white">--</p>
                    </div>
                </div>
            </div>

            <div class="bg-[#1e293b] p-5 rounded-xl border border-slate-700 shadow-xl overflow-hidden">
                <h3 class="text-slate-400 text-sm font-bold uppercase mb-4 tracking-wider">Active Incidents</h3>
                <div id="incident-list" class="space-y-3 max-h-[400px] overflow-y-auto pr-2">
                    <p class="text-slate-500 text-sm italic text-center">Fetching live reports...</p>
                </div>
            </div>
        </div>

        <div class="lg:col-span-3">
            <div class="relative shadow-2xl">
                <div id="map"></div>
                <div class="absolute bottom-4 right-4 bg-[#1e293b]/90 backdrop-blur p-3 rounded-lg border border-slate-700 z-[1000] text-xs space-y-2">
                    <div class="flex items-center"><span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span> High Urgency</div>
                    <div class="flex items-center"><span class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></span> Moderate</div>
                </div>
            </div>
        </div>

    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // 1. Initialize Supabase (Use your keys from .env/Screenshot 11:15:29 AM)
        const supabaseUrl = 'https://fxmwdwdkgppvhneqxfvf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ4bXdkd2RrZ3BwdmhuZXF4ZnZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MjMyMjgsImV4cCI6MjA4NjA4MzIyOH0.ZQGF4hZDbXpNWbBUzACHJUTtww3KzXVprAgQJf_dpu4';
        const supabase = supabasejs.createClient(supabaseUrl, supabaseKey);

        // 2. Initialize Leaflet Map (Centered on Jaipur)
        const map = L.map('map').setView([26.9124, 75.7873], 12);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        async function fetchIncidents() {
            // Fetching from your 'reports' table
            const { data, error } = await supabase.from('reports').select('*').order('created_at', { ascending: false });

            if (data) {
                const list = document.getElementById('incident-list');
                list.innerHTML = ''; // Clear loading text

                let ambTotal = 0;
                let fireTotal = 0;

                data.forEach(item => {
                    // Update AI Stats based on type
                    if (item.type === 'Accident') ambTotal += 2;
                    if (item.type === 'Fire') fireTotal += 3;

                    // Add Map Marker
                    const markerColor = item.urgency === 'High' ? 'red' : 'orange';
                    L.circleMarker([item.lat, item.lng], {
                        color: markerColor,
                        radius: 8,
                        fillOpacity: 0.8
                    }).addTo(map).bindPopup(`<b>${item.type}</b><br>${item.description}`);

                    // Add Card to Sidebar
                    const card = `
                        <div class="incident-card p-3 bg-slate-800 border-l-4 ${item.urgency === 'High' ? 'border-red-500' : 'border-yellow-500'} rounded shadow-sm">
                            <h4 class="font-bold text-sm">${item.type}</h4>
                            <p class="text-[10px] text-slate-400 mt-1 uppercase tracking-tighter">${new Date(item.created_at).toLocaleTimeString()}</p>
                        </div>
                    `;
                    list.innerHTML += card;
                });

                document.getElementById('amb-count').innerText = ambTotal;
                document.getElementById('fire-count').innerText = fireTotal;
            }
        }

        fetchIncidents();
    </script>
</body>
</html>